<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esports Premium Championship (EPC)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
      // This is a placeholder for module loading. The actual imports are in the main script.
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray */
            color: #F9FAFB; /* Light Gray */
        }
        .hero-section {
            background: linear-gradient(rgba(17, 24, 39, 0.8), rgba(17, 24, 39, 0.8)), url('https://placehold.co/1920x1080/000000/FFFFFF?text=EPC+Arena') no-repeat center center/cover;
        }
        .btn-primary {
            background-color: #3B82F6;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #2563EB;
        }
        .card {
            background-color: #1F2937; /* Darker Gray */
            border: 1px solid #374151; /* Gray border */
            cursor: pointer;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="antialiased">

    <!-- App Container -->
    <div id="app" class="min-h-screen">
        <!-- Will be dynamically rendered by JavaScript -->
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-y-auto modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md mx-auto relative">
            <button id="closeAdminModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Admin Login</h2>
            <form id="adminLoginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                    <input type="text" id="username" name="username" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" id="password" name="password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                 <p id="loginError" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                <button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-lg">Login</button>
            </form>
        </div>
    </div>

    <!-- Tournament Details Modal -->
    <div id="tournamentDetailsModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-y-auto modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl mx-auto relative max-h-[90vh] flex flex-col">
            <button id="closeDetailsModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <div id="detailsContent" class="overflow-y-auto">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>

    <!-- Generic Message Modal -->
    <div id="messageModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-y-auto modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md mx-auto text-center">
            <p id="modalMessage" class="text-white text-lg mb-6"></p>
            <button id="closeMessageModal" class="btn-primary text-white font-bold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden overflow-y-auto modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md mx-auto text-center">
            <p id="confirmMessage" class="text-white text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
                <button id="cancelBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc, 
            deleteDoc, 
            doc, 
            updateDoc,
            setDoc,
            getDoc,
            arrayUnion,
            query,
            where,
            orderBy,
            documentId
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration from your project
        const firebaseConfig = {
            apiKey: "AIzaSyBQRLjw6uU_99iBLNaONpg-EVOBCBN_EYw",
            authDomain: "esports-premium-championship.firebaseapp.com",
            projectId: "esports-premium-championship",
            storageBucket: "esports-premium-championship.appspot.com",
            messagingSenderId: "17019074381",
            appId: "1:17019074381:web:171b299dab8cbda25d2904",
            measurementId: "G-11YZM952SK"
        };

        let app, auth, db;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Error initializing Firebase:", error);
        }
        
        // --- STATE MANAGEMENT ---
        const state = {
            currentPage: 'home',
            user: null, // Will hold Firebase auth user object
            userData: null, // Will hold user profile data from Firestore
            tournaments: [],
            error: null,
            loading: true,
        };

        // --- ROUTER & RENDER ---
        const appContainer = document.getElementById('app');

        function navigate(page) {
            window.location.hash = page;
        }
        
        window.addEventListener('hashchange', render);
        window.addEventListener('load', render);

        async function render() {
            const path = window.location.hash.replace('#', '') || 'home';
            state.currentPage = path;
            
            // For dashboard, we fetch data first to prevent layout shifts and loops
            if (path === 'dashboard') {
                if (!state.user) {
                    navigate('signin');
                    return;
                }
                appContainer.innerHTML = Header() + '<p class="text-center text-white py-20">Loading Dashboard...</p>';
                await fetchTournaments();
                appContainer.innerHTML = Header() + await DashboardPage();
                updateDashboardView();
            } else {
                 appContainer.innerHTML = ''; // Clear previous content
                if (path !== 'admin') {
                    appContainer.innerHTML += Header();
                }

                switch (path) {
                    case 'home':
                        appContainer.innerHTML += await HomePage();
                        break;
                    case 'signup':
                        appContainer.innerHTML += SignUpPage();
                        break;
                    case 'signin':
                        appContainer.innerHTML += SignInPage();
                        break;
                    case 'admin':
                        if (!isAdmin()) {
                            showAdminLogin();
                            navigate('home');
                            return;
                        }
                        appContainer.innerHTML += await AdminPage();
                        break;
                    default:
                        appContainer.innerHTML += `<div class="text-center py-20"><h2 class="text-2xl">404 - Page Not Found</h2></div>`;
                }

                if (['home', 'admin'].includes(path)) {
                    fetchTournaments();
                }
            }
            attachEventListeners();
        }

        // --- COMPONENTS / PAGES ---

        function Header() {
            return `
                <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40">
                    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                        <a href="#home" class="text-2xl font-bold text-white">EPC</a>
                        <div class="flex items-center space-x-4">
                            <a href="#home" class="text-gray-300 hover:text-white">Home</a>
                            ${state.user ? `
                                <a href="#dashboard" class="text-gray-300 hover:text-white">Dashboard</a>
                                <button id="logoutBtn" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg text-sm">Logout</button>
                            ` : `
                                <a href="#signin" class="text-gray-300 hover:text-white">Sign In</a>
                                <a href="#signup" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg text-sm">Sign Up</a>
                            `}
                        </div>
                    </nav>
                </header>
            `;
        }

        async function HomePage() {
            return `
                <main>
                    <section class="hero-section text-white py-20 md:py-32">
                        <div class="container mx-auto text-center px-6">
                            <h1 class="text-4xl md:text-6xl font-black uppercase tracking-wider mb-4">Esports Premium Championship</h1>
                            <p class="text-lg md:text-xl text-gray-300 mb-8">The Ultimate Proving Ground for Aspiring Champions.</p>
                            <a href="#signup" class="btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">Join the Competition</a>
                        </div>
                    </section>
                    <section id="tournaments" class="py-20">
                        <div class="container mx-auto px-6">
                            <h2 class="text-3xl font-bold text-center mb-12">Upcoming Tournaments</h2>
                            <div id="tournament-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                ${state.loading ? '<p class="text-center col-span-full">Loading tournaments...</p>' : ''}
                            </div>
                        </div>
                    </section>
                </main>
                <footer class="bg-gray-900 py-6">
                    <div class="container mx-auto text-center text-gray-400">
                        <p>&copy; ${new Date().getFullYear()} Esports Premium Championship. All Rights Reserved.</p>
                        <button id="adminPanelBtn" class="text-sm text-gray-500 hover:text-white mt-2 underline">Admin Panel</button>
                    </div>
                </footer>
            `;
        }
        
        function TournamentCard(t) {
             const prize = t.prize_pool.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
            return `
                <div class="card rounded-lg overflow-hidden shadow-lg transform hover:-translate-y-2 transition-transform duration-300 flex flex-col" data-tournament-id="${t.id}">
                    <div class="p-6 flex-grow">
                        <h3 class="text-xl font-bold text-white mb-2">${t.title}</h3>
                        <p class="text-blue-400 font-semibold mb-3">${t.game}</p>
                        <p class="text-gray-300 mb-1"><span class="font-semibold">Date:</span> ${new Date(t.date).toLocaleDateString()}</p>
                        <p class="text-green-400 font-bold text-lg mb-4">Prize Pool: ${prize}</p>
                    </div>
                    <div class="p-6 pt-0 border-t border-gray-700 mt-4">
                        <p class="text-sm text-gray-300 text-center">Click to see details and register</p>
                    </div>
                </div>
            `;
        }

        function SignUpPage() {
            return `
                <div class="flex items-center justify-center py-20">
                    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
                        <h2 class="text-3xl font-bold text-center text-white mb-6">Create Account</h2>
                        <form id="signupForm">
                            <div class="mb-4">
                                <label for="signup-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                                <input type="email" id="signup-email" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                            </div>
                            <div class="mb-6">
                                <label for="signup-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                                <input type="password" id="signup-password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required minlength="6">
                            </div>
                            <p id="authError" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                            <button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-lg">Sign Up</button>
                        </form>
                        <p class="text-center text-gray-400 mt-4">
                            Already have an account? <a href="#signin" class="text-blue-400 hover:underline">Sign In</a>
                        </p>
                    </div>
                </div>
            `;
        }

        function SignInPage() {
            return `
                 <div class="flex items-center justify-center py-20">
                    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
                        <h2 class="text-3xl font-bold text-center text-white mb-6">Welcome Back</h2>
                        <form id="signinForm">
                            <div class="mb-4">
                                <label for="signin-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                                <input type="email" id="signin-email" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                            </div>
                            <div class="mb-6">
                                <label for="signin-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                                <input type="password" id="signin-password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                            </div>
                             <p id="authError" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                            <button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-lg">Sign In</button>
                        </form>
                         <p class="text-center text-gray-400 mt-4">
                            Don't have an account? <a href="#signup" class="text-blue-400 hover:underline">Sign Up</a>
                        </p>
                    </div>
                </div>
            `;
        }

        async function DashboardPage() {
            const games = [...new Set(state.tournaments.map(t => t.game))];
            const displayName = state.userData?.displayName;
            return `
                <div class="container mx-auto px-6 py-12">
                    <h1 class="text-3xl font-bold mb-2">Dashboard</h1>
                    <p class="text-gray-400 mb-8">Welcome back, ${displayName || state.user.email}.</p>
                    
                    ${!displayName ? `
                    <div class="bg-blue-900/50 border border-blue-700 rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold text-white mb-3">Set Your Display Name</h2>
                        <p class="text-blue-200 mb-4">You must set a public display name before you can register for tournaments.</p>
                        <form id="updateProfileForm" class="flex items-center gap-4">
                            <input type="text" id="displayNameInput" placeholder="Enter your name" class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                            <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded-lg">Save Name</button>
                        </form>
                    </div>
                    ` : ''}

                    <div class="flex flex-col md:flex-row gap-4 mb-8">
                        <input type="text" id="searchInput" placeholder="Search by tournament name..." class="w-full md:flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2">
                        <select id="gameFilter" class="w-full md:w-auto bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2">
                            <option value="">All Games</option>
                            ${games.map(game => `<option value="${game}">${game}</option>`).join('')}
                        </select>
                    </div>

                    <h2 class="text-2xl font-bold mb-4">All Tournaments</h2>
                    <div id="dashboard-tournament-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    </div>
                </div>
            `;
        }
        
        async function AdminPage() {
             return `
                <div class="bg-gray-900 min-h-screen">
                    <header class="bg-gray-800 shadow-md">
                        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                            <h1 class="text-xl font-bold text-white">EPC Admin Panel</h1>
                            <button id="adminLogoutBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Logout</button>
                        </div>
                    </header>
                    <main class="container mx-auto px-6 py-8">
                        <div class="bg-gray-800 rounded-lg shadow-xl p-8 mb-12">
                            <h2 class="text-2xl font-bold text-white mb-6">Add New Tournament</h2>
                            <form id="addTournamentForm">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="game" class="block text-sm font-medium text-gray-300 mb-2">Game Title</label>
                                        <input type="text" id="game" name="game" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                                    </div>
                                    <div>
                                        <label for="title" class="block text-sm font-medium text-gray-300 mb-2">Tournament Name</label>
                                        <input type="text" id="title" name="title" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                                    </div>
                                    <div>
                                        <label for="date" class="block text-sm font-medium text-gray-300 mb-2">Date</label>
                                        <input type="date" id="date" name="date" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                                    </div>
                                    <div>
                                        <label for="prize_pool" class="block text-sm font-medium text-gray-300 mb-2">Prize Pool ($)</label>
                                        <input type="number" id="prize_pool" name="prize_pool" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="description" class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                                        <textarea id="description" name="description" rows="4" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2" required></textarea>
                                    </div>
                                </div>
                                <button type="submit" class="mt-6 w-full md:w-auto btn-primary text-white font-bold py-2 px-6 rounded-lg">Add Tournament</button>
                            </form>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-6">Manage Tournaments</h2>
                            <div id="admin-tournament-list" class="space-y-4"></div>
                        </div>
                    </main>
                </div>
            `;
        }

        function AdminTournamentItem(t) {
            const prize = t.prize_pool.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
            return `
                <div class="bg-gray-800 p-4 rounded-lg flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <p class="font-bold text-white">${t.title} <span class="font-normal text-blue-400">(${t.game})</span></p>
                        <p class="text-sm text-gray-400">Date: ${new Date(t.date).toLocaleDateString()} | Prize: ${prize}</p>
                    </div>
                    <button data-tournament-id="${t.id}" class="delete-tournament-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-lg text-sm">Delete</button>
                </div>
            `;
        }

        // --- EVENT LISTENERS ---
        function attachEventListeners() {
            // Auth
            document.getElementById('signupForm')?.addEventListener('submit', handleSignUp);
            document.getElementById('signinForm')?.addEventListener('submit', handleSignIn);
            document.getElementById('logoutBtn')?.addEventListener('click', handleSignOut);
            document.getElementById('updateProfileForm')?.addEventListener('submit', handleUpdateProfile);
            
            // Admin
            document.getElementById('adminPanelBtn')?.addEventListener('click', showAdminLogin);
            document.getElementById('closeAdminModal')?.addEventListener('click', hideAdminLogin);
            document.getElementById('adminLoginForm')?.addEventListener('submit', handleAdminLogin);
            document.getElementById('adminLogoutBtn')?.addEventListener('click', handleAdminLogout);
            document.getElementById('addTournamentForm')?.addEventListener('submit', handleAddTournament);
            
            // Tournament Interaction
            document.querySelectorAll('.delete-tournament-btn').forEach(btn => btn.addEventListener('click', handleDeleteTournament));
            document.querySelectorAll('.card').forEach(card => card.addEventListener('click', (e) => showTournamentDetails(e.currentTarget.dataset.tournamentId)));
            document.getElementById('closeDetailsModal')?.addEventListener('click', hideTournamentDetails);

            // Dashboard Filtering
            document.getElementById('searchInput')?.addEventListener('input', updateDashboardView);
            document.getElementById('gameFilter')?.addEventListener('change', updateDashboardView);
        }
        
        // --- DATA FETCHING & MANIPULATION ---
        async function fetchTournaments() {
            state.loading = true;
            updateTournamentLists(); 

            try {
                if (!db) {
                    state.tournaments = [];
                } else {
                    const tournamentsCol = collection(db, "tournaments");
                    const q = query(tournamentsCol, orderBy("date", "asc"));
                    const tournamentSnapshot = await getDocs(q);
                    state.tournaments = tournamentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                state.error = null;
            } catch (error) {
                console.error('Error fetching tournaments:', error);
                state.error = "Could not fetch tournaments.";
                state.tournaments = [];
            } finally {
                state.loading = false;
                updateTournamentLists();
            }
        }
        
        function updateTournamentLists() {
            const tournamentList = document.getElementById('tournament-list');
            if (tournamentList) {
                if(state.loading) {
                    tournamentList.innerHTML = '<p class="text-center col-span-full">Loading tournaments...</p>';
                    return;
                }
                tournamentList.innerHTML = state.tournaments.length > 0
                    ? state.tournaments.map(TournamentCard).join('')
                    : `<p class="text-center col-span-full">${state.error || 'No upcoming tournaments.'}</p>`;
            }
            
            const adminTournamentList = document.getElementById('admin-tournament-list');
            if (adminTournamentList) {
                adminTournamentList.innerHTML = state.tournaments.length > 0
                    ? state.tournaments.map(AdminTournamentItem).join('')
                    : `<p class="text-center">${state.error || 'No tournaments found.'}</p>`;
            }

            updateDashboardView();
            attachEventListeners();
        }

        function updateDashboardView() {
            const dashboardList = document.getElementById('dashboard-tournament-list');
            if (!dashboardList) return;

            if(state.loading && state.currentPage === 'dashboard') {
                dashboardList.innerHTML = '<p class="text-center col-span-full">Loading tournaments...</p>';
                return;
            }

            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const selectedGame = document.getElementById('gameFilter')?.value || '';

            const filteredTournaments = state.tournaments.filter(t => {
                const matchesSearch = t.title.toLowerCase().includes(searchTerm);
                const matchesGame = selectedGame ? t.game === selectedGame : true;
                return matchesSearch && matchesGame;
            });

            dashboardList.innerHTML = filteredTournaments.length > 0
                ? filteredTournaments.map(TournamentCard).join('')
                : `<p class="text-gray-400 col-span-full">No tournaments match your criteria.</p>`;
            
            attachEventListeners();
        }

        // --- HANDLERS ---
        async function handleSignUp(e) {
            e.preventDefault();
            if (!auth) return showMessage("Firebase not configured.");
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Create a user profile document in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    email: user.email,
                    displayName: null
                });
                showMessage('Sign up successful! Please sign in and set your display name.');
                navigate('signin');
            } catch (error) {
                document.getElementById('authError').textContent = error.message;
                document.getElementById('authError').classList.remove('hidden');
            }
        }

        async function handleSignIn(e) {
            e.preventDefault();
            if (!auth) return showMessage("Firebase not configured.");
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('authError').textContent = error.message;
                document.getElementById('authError').classList.remove('hidden');
            }
        }

        async function handleSignOut() {
            if (auth) await signOut(auth);
            sessionStorage.removeItem('is_admin');
            state.user = null;
            state.userData = null;
            navigate('home');
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            if (!db || !state.user) return;
            const newName = document.getElementById('displayNameInput').value;
            if (!newName) return showMessage("Please enter a name.");

            const userRef = doc(db, "users", state.user.uid);
            try {
                // Use setDoc with merge: true. This will create the document if it doesn't exist,
                // and update it if it does. This fixes the "No document to update" error for old user accounts.
                await setDoc(userRef, { displayName: newName }, { merge: true });
                
                // Also update the local state to reflect the change immediately
                if(!state.userData) state.userData = {};
                state.userData.displayName = newName;

                showMessage("Profile updated successfully!");
                render(); // Re-render the dashboard
            } catch (error) {
                showMessage("Error updating profile: " + error.message);
                console.error("Error updating profile:", error);
            }
        }

        async function handleAddTournament(e) {
            e.preventDefault();
            if (!db) return showMessage("Firebase not configured.");
            const form = e.target;
            const newTournament = {
                game: form.game.value,
                title: form.title.value,
                date: form.date.value,
                prize_pool: parseInt(form.prize_pool.value, 10),
                description: form.description.value,
                registered_users: []
            };
            try {
                await addDoc(collection(db, "tournaments"), newTournament);
                form.reset();
                fetchTournaments();
            } catch (error) {
                showMessage('Error adding tournament: ' + error.message);
            }
        }

        async function handleDeleteTournament(e) {
            e.stopPropagation(); // Prevent modal from opening
            const tournamentId = e.target.dataset.tournamentId;
            showConfirmation('Are you sure you want to delete this tournament?', async () => {
                if (!db) return showMessage("Firebase not configured.");
                try {
                    await deleteDoc(doc(db, "tournaments", tournamentId));
                    fetchTournaments();
                } catch (error) {
                    showMessage('Error deleting tournament: ' + error.message);
                }
            });
        }
        
        async function handleRegisterForTournament(e) {
            e.stopPropagation();
            if (!state.user) return showMessage("You must be signed in to register.");
            if (!state.userData?.displayName) {
                return showMessage("Please set your display name on the dashboard before registering.");
            }
            if (!db) return showMessage("Firebase not configured.");

            const tournamentId = e.target.dataset.tournamentId;
            const tournamentRef = doc(db, "tournaments", tournamentId);
            
            try {
                await updateDoc(tournamentRef, {
                    registered_users: arrayUnion(state.user.uid)
                });
                showMessage("Successfully registered!");
                await fetchTournaments();
                hideTournamentDetails();
                showTournamentDetails(tournamentId); // Refresh the details modal
            } catch (error) {
                showMessage("Error registering for tournament: " + error.message);
            }
        }

        // --- ADMIN AUTH ---
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
            document.getElementById('adminLoginModal').classList.add('flex');
        }
        function hideAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminLoginModal').classList.remove('flex');
        }
        function handleAdminLogin(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (user === 'Mostafa' && pass === '123456789#Osama') {
                sessionStorage.setItem('is_admin', 'true');
                hideAdminLogin();
                navigate('admin');
            } else {
                document.getElementById('loginError').textContent = 'Invalid username or password.';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }
        function handleAdminLogout() {
            sessionStorage.removeItem('is_admin');
            navigate('home');
        }
        function isAdmin() {
            return sessionStorage.getItem('is_admin') === 'true';
        }
        
        // --- MODAL HELPERS ---
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeMessageModalBtn = document.getElementById('closeMessageModal');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const detailsModal = document.getElementById('tournamentDetailsModal');
        const detailsContent = document.getElementById('detailsContent');

        function showMessage(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }
        closeMessageModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
        });

        function showConfirmation(message, onConfirm) {
            confirmMessage.textContent = message;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
            const newConfirmBtn = confirmBtn.cloneNode(true); 
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideConfirmation();
            });
        }
        cancelBtn.addEventListener('click', hideConfirmation);
        function hideConfirmation() {
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
        }

        async function showTournamentDetails(tournamentId) {
            const t = state.tournaments.find(t => t.id === tournamentId);
            if (!t) return;

            detailsContent.innerHTML = `<p class="text-center text-white">Loading details...</p>`;
            detailsModal.classList.remove('hidden');
            detailsModal.classList.add('flex');

            let registeredPlayers = [];
            if (t.registered_users && t.registered_users.length > 0) {
                const usersRef = collection(db, "users");
                // Correctly query by document ID
                const q = query(usersRef, where(documentId(), 'in', t.registered_users));
                const userSnapshot = await getDocs(q);
                registeredPlayers = userSnapshot.docs.map(doc => doc.data().displayName || 'Anonymous');
            }

            const prize = t.prize_pool.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
            const isRegistered = state.user && t.registered_users && t.registered_users.includes(state.user.uid);

            detailsContent.innerHTML = `
                <h2 class="text-3xl font-bold text-white mb-2">${t.title}</h2>
                <p class="text-blue-400 font-semibold mb-4">${t.game}</p>
                <div class="text-gray-300 mb-6 prose prose-invert max-w-none">${t.description.replace(/\n/g, '<br>')}</div>
                <div class="border-t border-gray-700 pt-6">
                    <h3 class="text-xl font-bold text-white mb-4">Registered Players (${registeredPlayers.length})</h3>
                    ${registeredPlayers.length > 0 ? `
                        <ul class="grid grid-cols-2 md:grid-cols-3 gap-2 text-gray-400">
                            ${registeredPlayers.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                    ` : `<p class="text-gray-500">No players have registered yet.</p>`}
                </div>
                <div class="mt-8">
                ${state.user ? `
                    <button class="w-full py-3 px-4 rounded-lg font-bold text-white ${isRegistered ? 'bg-green-600 cursor-not-allowed' : 'btn-primary register-btn-modal'}" data-tournament-id="${t.id}" ${isRegistered ? 'disabled' : ''}>
                        ${isRegistered ? 'Successfully Registered' : 'Register for this Tournament'}
                    </button>
                ` : `
                    <a href="#signin" class="block text-center w-full py-3 px-4 rounded-lg font-bold text-white btn-primary">Sign In to Register</a>
                `}
                </div>
            `;
            // Re-attach listener for the new button inside the modal
            document.querySelector('.register-btn-modal')?.addEventListener('click', handleRegisterForTournament);
        }

        function hideTournamentDetails() {
            detailsModal.classList.add('hidden');
            detailsModal.classList.remove('flex');
        }

        // --- INITIALIZATION ---
        function initialize() {
            if (!auth) {
                showMessage("Firebase could not be initialized.");
                render();
                return;
            }
            onAuthStateChanged(auth, async (user) => {
                const wasLoggedIn = !!state.user;
                if (user) {
                    state.user = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    state.userData = userDoc.exists() ? userDoc.data() : null;
                } else {
                    state.user = null;
                    state.userData = null;
                }
                
                const isLoggedIn = !!user;
                // Only re-render or navigate if the auth state has actually changed.
                if (wasLoggedIn !== isLoggedIn) {
                    if (isLoggedIn && ['signin', 'signup', ''].includes(state.currentPage)) {
                        navigate('dashboard');
                    } else if (!isLoggedIn && (state.currentPage === 'dashboard' || state.currentPage === 'admin')) {
                        navigate('home');
                    } else {
                        render();
                    }
                }
            });
        }
        
        initialize();

    </script>
</body>
</html>
